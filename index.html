<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GADU App - Contenedores</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* CSS Base */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .header-logo { height: 50px; width: auto; }
        .product-card-link { text-decoration: none; color: inherit; }

        /* Estilos específicos del Carrusel de Banners */
        .banner-slide {
            display: none;
            height: 100%; 
            width: 100%;
        }
        .banner-slide.active {
            display: block;
        }
        .banner-dot {
            height: 10px; width: 10px; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; cursor: pointer; transition: background-color 0.3s ease;
        }
        .banner-dot.active {
            background-color: #13B71C;
        }

        /* Estilos para el carrusel de imágenes de productos */
        .image-carousel {
            position: relative; width: 100%; height: 192px; overflow: hidden; border-radius: 0.5rem;
        }
        .image-carousel img {
            width: 100%; height: 100%; object-fit: cover; display: none;
        }
        .image-carousel img.active {
            display: block;
        }
        .carousel-btn {
            position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.5); color: white; padding: 8px; border-radius: 50%; cursor: pointer; z-index: 10; transition: background-color 0.3s ease;
        }
        .carousel-btn:hover { background-color: rgba(0, 0, 0, 0.8); }
        .carousel-btn.prev { left: 8px; }
        .carousel-btn.next { right: 8px; }
        .carousel-dots {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 10;
        }
        .image-dot {
            height: 10px; width: 10px; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; cursor: pointer; transition: background-color 0.3s ease;
        }
        .image-dot.active { background-color: #13B71C; }
        
        /* Estilo para las burbujas de categoría */
        .category-bubble:hover {
            box-shadow: 0 4px 10px rgba(19, 183, 28, 0.4);
            background-color: white; 
        }
    </style>
    <link rel="icon" href="assets/icon.png">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="bg-white shadow-md relative z-50"> 
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2">
                <img src="assets/icon.png" alt="GADU Containers Logo" class="header-logo">
                <span class="text-3xl font-bold text-gray-800">
                    <span style="color: #13B71C;">GADU</span>
                </span>
            </a>
            
            <nav class="hidden sm:block"> 
                <ul class="flex space-x-4">
                    <li><a href="#" class="text-gray-600 hover:text-green-600 transition-colors duration-300 font-medium">Inicio</a></li>
                    <li><a href="contact.html" class="text-gray-600 hover:text-green-600 transition-colors duration-300 font-medium">Contacto</a></li>
                </ul>
            </nav>

            <button id="mobile-menu-button" class="sm:hidden text-gray-600 hover:text-green-600 p-2 rounded">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
        
        <nav id="mobile-menu" class="hidden absolute w-full bg-white shadow-lg border-t border-gray-200">
            <ul class="flex flex-col p-4 space-y-2">
                <li><a href="#" class="text-gray-700 hover:text-green-600 transition-colors duration-300 font-medium block p-2 rounded hover:bg-gray-100">Inicio</a></li>
                <li><a href="contact.html" class="text-gray-700 hover:text-green-600 transition-colors duration-300 font-medium block p-2 rounded hover:bg-gray-100">Contacto</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">

        <div id="banner-carousel" class="relative w-full h-[200px] sm:h-[350px] md:h-[450px] lg:h-[550px] rounded-2xl overflow-hidden shadow-2xl mb-10">
            
            <div class="banner-slide active" 
                 style="background-image: url('assets/bannerglobal.png'); background-size: cover; background-position: center;">
            </div>
            
            <div class="banner-slide" 
                 style="background-image: url('assets/bannertech.png'); background-size: cover; background-position: center;">
            </div>

            <div class="banner-slide" 
                 style="background-image: url('assets/bannersport.png'); background-size: cover; background-position: center;">
            </div>

            <div class="banner-slide" 
                 style="background-image: url('assets/bannerfashion.png'); background-size: cover; background-position: center;">
            </div>
            
            <button id="banner-prev" class="carousel-btn prev p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <button id="banner-next" class="carousel-btn next p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>

            <div id="banner-dots-container" class="carousel-dots">
                <span class="banner-dot active" data-index="0"></span>
                <span class="banner-dot" data-index="1"></span>
                <span class="banner-dot" data-index="2"></span>
                <span class="banner-dot" data-index="3"></span>
            </div>
        </div>
        
        <div class="py-6 mb-10 bg-white rounded-xl shadow-lg">
            <div id="category-bubbles" class="flex justify-around items-start flex-wrap gap-4 md:gap-8 px-4">
                
                <div class="category-bubble text-center cursor-pointer p-2 sm:p-4 rounded-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-50" data-category="Tecnologia">
                    <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-2 rounded-full flex items-center justify-center border-4" style="border-color: #13B71C; background-color: rgba(19, 183, 28, 0.1);">
                        <img src="assets/icon-tecnologia.png" alt="Icono Tecnología" class="w-10 h-10 sm:w-12 sm:h-12 object-contain">
                    </div>
                    <p class="font-semibold text-gray-700 text-sm sm:text-base">Tecnología</p>
                </div>
                
                <div class="category-bubble text-center cursor-pointer p-2 sm:p-4 rounded-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-50" data-category="Moda">
                    <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-2 rounded-full flex items-center justify-center border-4" style="border-color: #13B71C; background-color: rgba(19, 183, 28, 0.1);">
                        <img src="assets/icon-moda.png" alt="Icono Moda" class="w-10 h-10 sm:w-12 sm:h-12 object-contain">
                    </div>
                    <p class="font-semibold text-gray-700 text-sm sm:text-base">Moda</p>
                </div>
                
                <div class="category-bubble text-center cursor-pointer p-2 sm:p-4 rounded-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-50" data-category="Calzado">
                    <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-2 rounded-full flex items-center justify-center border-4" style="border-color: #13B71C; background-color: rgba(19, 183, 28, 0.1);">
                        <img src="assets/icon-calzado.png" alt="Icono Calzado" class="w-10 h-10 sm:w-12 sm:h-12 object-contain">
                    </div>
                    <p class="font-semibold text-gray-700 text-sm sm:text-base">Calzado</p>
                </div>
                
                <div class="category-bubble text-center cursor-pointer p-2 sm:p-4 rounded-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-50" data-category="all">
                    <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-2 rounded-full flex items-center justify-center border-4" style="border-color: #13B71C; background-color: rgba(19, 183, 28, 0.1);">
                    <img src="assets/icon-todo.png" alt="Icono Ver Todo" class="w-10 h-10 sm:w-12 sm:h-12 object-contain">
                    </div>
                    <p class="font-semibold text-gray-700 text-sm sm:text-base">Ver Todo</p>
                </div>
            </div>
        </div>
        
        <h1 class="text-center text-3xl sm:text-4xl font-extrabold text-gray-800 mb-8">Nuestros Productos</h1>

        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm mb-8 flex flex-col md:flex-row justify-between items-start md:items-end space-y-4 md:space-y-0 md:space-x-4">
    
            <div class="w-full md:flex-1">
                <label for="search-input" class="block text-gray-700 font-semibold mb-1 text-sm sm:text-base">Buscar:</label>
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="Nombre, Categoría o Subcategoría" 
                    class="w-full p-2 border border-green-500 rounded-md focus:outline-none focus:ring-2 focus:ring-green-300 text-sm sm:text-base" 
                    style="border-color: #13B71C; box-shadow: 0 0 0 1px #13B71C;">
            </div>

            <div class="w-full md:flex-1">
                <label for="category-filter" class="block text-gray-700 font-semibold mb-1 text-sm sm:text-base">Categoría:</label>
                <select 
                    id="category-filter" 
                    class="w-full p-2 border border-green-500 rounded-md focus:outline-none focus:ring-2 focus:ring-green-300 appearance-none bg-white pr-8 text-sm sm:text-base"
                    style="border-color: #13B71C; box-shadow: 0 0 0 1px #13B71C;">
                    <option value="all">Todas las Categorías</option>
                    </select>
            </div>

            <div class="w-full md:flex-1">
                <label for="subcategory-filter" class="block text-gray-700 font-semibold mb-1 text-sm sm:text-base">Subcategoría:</label>
                <select 
                    id="subcategory-filter" 
                    class="w-full p-2 border border-green-500 rounded-md focus:outline-none focus:ring-2 focus:ring-green-300 appearance-none bg-white pr-8 text-sm sm:text-base"
                    style="border-color: #13B71C; box-shadow: 0 0 0 1px #13B71C;">
                    <option value="all">Todas las Subcategorías</option>
                    </select>
            </div>

            <div class="w-full md:flex-1">
                <label for="sort-by-price" class="block text-gray-700 font-semibold mb-1 text-sm sm:text-base">Precio:</label>
                <select 
                    id="sort-by-price" 
                    class="w-full p-2 border border-green-500 rounded-md focus:outline-none focus:ring-2 focus:ring-green-300 appearance-none bg-white pr-8 text-sm sm:text-base"
                    style="border-color: #13B71C; box-shadow: 0 0 0 1px #13B71C;">
                    <option value="default">Por Defecto</option>
                    <option value="asc">Menor a Mayor</option>
                    <option value="desc">Mayor a Menor</option>
                </select>
            </div>
        </div>
        
        <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6">
        </div>

        <div id="pagination-controls" class="flex justify-center items-center space-x-2 sm:space-x-4 mt-8">
            </div>

        <div id="message" class="text-center text-gray-500 font-medium mt-8 hidden"></div>
    </main>

    <footer class="text-white text-center p-4" style="background-color: #84a484;">
        <div class="container mx-auto">
            <p class="text-sm sm:text-base">&copy; 2024 GADU App. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // **PASO 1: Inserta tu objeto de configuración de Firebase aquí**
        const firebaseConfig = {
            apiKey: "AIzaSyCsRnbAvV5vLDv5-rMq8uT7rcCK9YRz-UA",
            authDomain: "appgadustore.firebaseapp.com",
            projectId: "appgadustore",
            storageBucket: "appgadustore.firebasestorage.app",
            messagingSenderId: "761196485216",
            appId: "1:761196485216:web:612176268c5f2480304105",
            measurementId: "G-VDKN4343F7"
        };

        // Inicializa Firebase
        let firebaseApp;
        let db;
        try {
            firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
        } catch (e) {
            console.error("Error al inicializar Firebase. Revisa tu objeto de configuración.", e);
        }

        const productsContainer = document.getElementById('products-container');
        const messageElement = document.getElementById('message');
        const categoryFilter = document.getElementById('category-filter');
        const subcategoryFilter = document.getElementById('subcategory-filter');
        const sortByPrice = document.getElementById('sort-by-price');
        const searchInput = document.getElementById('search-input');
        const paginationControls = document.getElementById('pagination-controls');
        
        // **VARIABLES DE PAGINACIÓN LOCAL**
        let allProducts = []; 
        let filteredAndSortedProducts = []; 
        let currentPage = 1;
        const productsPerPage = 12; 

        // === Lógica del Carrusel de Banners (sin cambios) ===
        const bannerSlides = document.querySelectorAll('#banner-carousel .banner-slide');
        const bannerDotsContainer = document.getElementById('banner-dots-container');
        const bannerPrevBtn = document.getElementById('banner-prev');
        const bannerNextBtn = document.getElementById('banner-next');
        let currentBannerIndex = 0;
        let bannerInterval;
        const totalBanners = bannerSlides.length;

        const updateBannerCarousel = (newIndex) => {
            if (totalBanners === 0) return;
            let finalIndex = (newIndex + totalBanners) % totalBanners;
            
            bannerSlides.forEach(slide => slide.classList.remove('active'));
            const bannerDots = bannerDotsContainer.querySelectorAll('.banner-dot');
            bannerDots.forEach(dot => dot.classList.remove('active'));
            
            bannerSlides[finalIndex].classList.add('active');
            if (bannerDots[finalIndex]) {
                bannerDots[finalIndex].classList.add('active');
            }
            currentBannerIndex = finalIndex;
        };

        const startBannerAutoPlay = () => {
            clearInterval(bannerInterval);
            bannerInterval = setInterval(() => {
                updateBannerCarousel(currentBannerIndex + 1);
            }, 5000);
        };
        
        const setupBannerListeners = () => {
            bannerNextBtn.addEventListener('click', () => { updateBannerCarousel(currentBannerIndex + 1); startBannerAutoPlay(); });
            bannerPrevBtn.addEventListener('click', () => { updateBannerCarousel(currentBannerIndex - 1); startBannerAutoPlay(); });
            bannerDotsContainer.querySelectorAll('.banner-dot').forEach(dot => {
                dot.addEventListener('click', (e) => {
                    updateBannerCarousel(parseInt(e.target.dataset.index));
                    startBannerAutoPlay();
                });
            });
            startBannerAutoPlay();
        };
        // === FIN: Lógica del Carrusel de Banners ===
        
        // Función para mostrar mensajes de estado
        const showMessage = (msg) => {
            messageElement.textContent = msg;
            messageElement.classList.remove('hidden');
        };

        // Rellena el dropdown de Subcategorías (sin cambios)
        const updateSubcategories = () => {
            const selectedCategory = categoryFilter.value;
            const productsSource = allProducts.length > 0 ? allProducts : [];
            
            const subcategories = (selectedCategory === 'all')
                ? [...new Set(productsSource.map(p => p.subcategory).filter(Boolean))]
                : [...new Set(productsSource.filter(p => p.category === selectedCategory).map(p => p.subcategory).filter(Boolean))];

            const currentSubcategoryValue = subcategoryFilter.value;

            subcategoryFilter.innerHTML = '<option value="all">Todas las Subcategorías</option>';
            subcategories.sort().forEach(subcategory => { 
                const option = document.createElement('option');
                option.value = subcategory;
                option.textContent = subcategory;
                subcategoryFilter.appendChild(option);
            });

            if ([...subcategoryFilter.options].some(opt => opt.value === currentSubcategoryValue)) {
                 subcategoryFilter.value = currentSubcategoryValue;
            } else {
                 subcategoryFilter.value = 'all';
            }
        };

        // Rellena el dropdown de Categorías (sin cambios)
        const populateCategories = (products) => {
            const categories = [...new Set(products.map(p => p.category).filter(Boolean))].sort();
            const currentCategoryValue = categoryFilter.value;

            categoryFilter.innerHTML = '<option value="all">Todas las Categorías</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
            
            if ([...categoryFilter.options].some(opt => opt.value === currentCategoryValue)) {
                 categoryFilter.value = currentCategoryValue;
            } else {
                 categoryFilter.value = 'all';
            }

            updateSubcategories(); 
        };
        
        // Setup de burbujas de categoría (sin cambios)
        const setupCategoryBubbles = () => {
            const bubbles = document.querySelectorAll('.category-bubble');
            bubbles.forEach(bubble => {
                bubble.addEventListener('click', () => {
                    const category = bubble.dataset.category;
                    
                    categoryFilter.value = category === 'all' ? 'all' : category; 
                    subcategoryFilter.value = 'all';
                    searchInput.value = '';
                    
                    // Al cambiar filtros, siempre volvemos a la página 1
                    currentPage = 1; 
                    filterAndSortProducts();

                    document.getElementById('products-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
        };
        
        // ==========================================================
        // FUNCIÓN: renderPaginationControls
        // ==========================================================
        const renderPaginationControls = (totalProducts) => {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalProducts / productsPerPage);

            if (totalPages <= 1) {
                return;
            }

            // Botón Anterior
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.className = `px-3 py-1 sm:px-4 sm:py-2 rounded-lg font-semibold text-sm sm:text-base transition-colors duration-200 ${
                currentPage === 1 
                ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                : 'bg-green-500 text-white hover:bg-green-600'
            }`;
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    filterAndSortProducts();
                }
            });
            paginationControls.appendChild(prevButton);

            // Indicador de página
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            pageInfo.className = 'text-gray-700 font-medium mx-2 sm:mx-4 text-sm sm:text-base';
            paginationControls.appendChild(pageInfo);

            // Botón Siguiente
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Siguiente';
            nextButton.className = `px-3 py-1 sm:px-4 sm:py-2 rounded-lg font-semibold text-sm sm:text-base transition-colors duration-200 ${
                currentPage === totalPages
                ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                : 'bg-green-500 text-white hover:bg-green-600'
            }`;
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    filterAndSortProducts();
                }
            });
            paginationControls.appendChild(nextButton);
            
            // Subir al contenedor de productos
            document.getElementById('products-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        };


        // ==========================================================
        // FUNCIÓN CLAVE: filterAndSortProducts 
        // ==========================================================
        const filterAndSortProducts = () => {
            let tempProducts = [...allProducts]; 
            const selectedCategory = categoryFilter.value;
            const selectedSubcategory = subcategoryFilter.value; 
            const selectedSort = sortByPrice.value;
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // 1. FILTRADO (CATEGORÍA, SUBCATEGORÍA, BÚSQUEDA)
            if (selectedCategory !== 'all') {
                tempProducts = tempProducts.filter(p => p.category === selectedCategory);
            }
            if (selectedSubcategory !== 'all') {
                tempProducts = tempProducts.filter(p => p.subcategory === selectedSubcategory);
            }
            if (searchTerm) {
                tempProducts = tempProducts.filter(product => {
                    const nameMatch = product.name.toLowerCase().includes(searchTerm);
                    const categoryMatch = product.category ? product.category.toLowerCase().includes(searchTerm) : false;
                    const subcategoryMatch = product.subcategory ? product.subcategory.toLowerCase().includes(searchTerm) : false;
                    const idMatch = product.id.toLowerCase().includes(searchTerm); 
                    return nameMatch || categoryMatch || subcategoryMatch || idMatch;
                });
            }

            // 2. ORDENAMIENTO POR PRECIO/DEFECTO
            if (selectedSort !== 'default') {
                tempProducts.sort((a, b) => {
                    const priceA = a.price || 0;
                    const priceB = b.price || 0;
                    return selectedSort === 'asc' ? priceA - priceB : priceB - priceA;
                });
            } else {
                tempProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            }
            
            // Guardar la lista COMPLETA filtrada y ordenada
            filteredAndSortedProducts = tempProducts;

            // 3. PAGINACIÓN
            const totalProducts = filteredAndSortedProducts.length;
            const startIndex = (currentPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            
            // Productos a renderizar en la página actual
            const productsToRender = filteredAndSortedProducts.slice(startIndex, endIndex);

            // 4. Renderizar y Controles de Paginación
            renderProducts(productsToRender);
            renderPaginationControls(totalProducts);
        };


        // Carga todos los productos de Firebase (sin cambios)
        const fetchProducts = async () => {
            try {
                // El mensaje de error que estás viendo está aquí. Se muestra aunque se carguen todos los productos.
                showMessage('Cargando todos los productos...'); 
                if (!db) {
                    throw new Error('Firestore no está inicializado.');
                }
                
                // Carga TODOS los documentos
                const productsSnapshot = await getDocs(query(collection(db, 'products')));
                
                // Mapear datos y guardar en allProducts
                allProducts = productsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Poblar categorías y subcategorías
                populateCategories(allProducts); 
                
                // Aplicar filtros iniciales (que ahora incluye paginación)
                currentPage = 1; 
                filterAndSortProducts();

            } catch (error) {
                // **ATENCIÓN:** El error mostrado en tu consola (The query requires an index)
                // ocurre si usas la colección 'products' en una consulta que involucra
                // múltiples filtros (categoría, subcategoría, precio) o si ordenas
                // con un campo diferente al de filtro.
                showMessage(`Error al cargar productos (ver consola para detalles).`); 
                console.error('Error de Firebase:', error);
            }
        };

        // Event Listeners para filtros (sin cambios en la lógica)
        const setupFilterListeners = () => {
            const filterChangeHandler = () => {
                currentPage = 1; // Reinicia la página al cambiar cualquier filtro
                filterAndSortProducts();
            };

            categoryFilter.addEventListener('change', () => {
                updateSubcategories(); 
                filterChangeHandler();
            }); 
            
            subcategoryFilter.addEventListener('change', filterChangeHandler);
            sortByPrice.addEventListener('change', filterChangeHandler);
            searchInput.addEventListener('input', filterChangeHandler);
        };

        // ==========================================================
        // LÓGICA DEL MENÚ MÓVIL (NUEVA)
        // ==========================================================
        const setupMobileMenuToggle = () => {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            mobileMenuButton.addEventListener('click', () => {
                // Simplemente alterna la clase 'hidden'
                mobileMenu.classList.toggle('hidden');
            });
        };

        // Iniciar la carga y los listeners al cargar la página
        window.addEventListener('load', () => {
            setupBannerListeners();
            setupCategoryBubbles(); 
            setupFilterListeners();
            setupMobileMenuToggle(); // **Nueva llamada**
            fetchProducts();
        });

        // ==========================================================
        // FUNCIONES DE CARRUSEL Y RENDERIZADO (sin cambios en la lógica)
        // ==========================================================

        const renderProductCard = (product) => {
            const imageUrls = Array.isArray(product.imageUrl) ? product.imageUrl : [product.imageUrl];
            const hasMultipleImages = imageUrls.length > 1;

            const imagesHtml = imageUrls.map((url, index) => {
                return `<img src="${url}" alt="${product.name} - ${index + 1}" class="w-full h-full object-cover ${index === 0 ? 'active' : ''}">`;
            }).join('');

            const dotsHtml = hasMultipleImages ? imageUrls.map((_, index) => {
                return `<span class="image-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`;
            }).join('') : '';

            let categorySubcategoryHtml = `<p class="text-xs sm:text-sm text-gray-500 mb-2">${product.category || 'Sin Categoría'}</p>`;

            if (product.category && product.subcategory) {
                categorySubcategoryHtml = `<p class="text-xs sm:text-sm text-gray-500 mb-2">${product.category} | ${product.subcategory}</p>`;
            }

            return `
                <a href="product-details.html?id=${product.id}" class="product-card-link">
                    <div class="relative bg-white p-4 sm:p-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 overflow-hidden" style="box-shadow: 0 4px 6px -1px #84a484, 0 2px 4px -1px #84a484;">
                        <div class="image-carousel" data-product-id="${product.id}" data-current-index="0" data-has-multiple="${hasMultipleImages}">
                            ${imagesHtml}
                            ${hasMultipleImages ? `
                                <button class="carousel-btn prev" onclick="event.preventDefault(); event.stopPropagation();">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                    </svg>
                                </button>
                                <button class="carousel-btn next" onclick="event.preventDefault(); event.stopPropagation();">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                </button>
                                <div class="carousel-dots">
                                    ${dotsHtml}
                                </div>
                            ` : ''}
                        </div>
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800 mt-4 mb-1">${product.name}</h2>
                        ${categorySubcategoryHtml}
                        <p class="text-xl sm:text-2xl font-extrabold" style="color: #13B71C;">$${product.price ? product.price.toLocaleString('es-CO') : 'N/A'}</p>
                    </div>
                </a >
            `;
        };

        const updateCarousel = (carousel, newIndex) => {
            const images = carousel.querySelectorAll('img');
            const dots = carousel.querySelectorAll('.image-dot');
            const totalImages = images.length;
            
            if (totalImages === 0) return;

            const finalIndex = (newIndex + totalImages) % totalImages;
            
            images.forEach(img => img.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));

            images[finalIndex].classList.add('active');
            if (dots[finalIndex]) {
                dots[finalIndex].classList.add('active');
            }

            carousel.dataset.currentIndex = finalIndex;
        };
        
        const setupCarousels = () => {
            const carousels = document.querySelectorAll('.image-carousel');
            carousels.forEach(carousel => {
                if (carousel.dataset.initialized) return;

                const hasMultipleImages = carousel.dataset.hasMultiple === 'true';
                if (!hasMultipleImages) return;

                const prevBtn = carousel.querySelector('.prev');
                const nextBtn = carousel.querySelector('.next');
                const dots = carousel.querySelectorAll('.image-dot');

                updateCarousel(carousel, 0);

                const handleNavigation = (e, step) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const currentIndex = parseInt(carousel.dataset.currentIndex);
                    updateCarousel(carousel, currentIndex + step);
                };

                nextBtn.addEventListener('click', (e) => handleNavigation(e, 1));
                prevBtn.addEventListener('click', (e) => handleNavigation(e, -1));

                dots.forEach(dot => {
                    dot.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const newIndex = parseInt(e.target.dataset.index);
                        updateCarousel(carousel, newIndex);
                    });
                });

                carousel.dataset.initialized = 'true';
            });
        };

        const renderProducts = (productsToRender) => {
            if (productsToRender.length === 0 && (categoryFilter.value !== 'all' || subcategoryFilter.value !== 'all' || searchInput.value)) {
                productsContainer.innerHTML = '';
                showMessage('No se encontraron productos que coincidan con los filtros.');
                return;
            }
            if (productsToRender.length === 0 && filteredAndSortedProducts.length > 0) {
                // Esto puede ocurrir si el usuario avanza a una página vacía, lo corregimos reseteando a la página 1
                currentPage = 1;
                filterAndSortProducts();
                return;
            }
            if (productsToRender.length === 0) {
                productsContainer.innerHTML = '';
                showMessage('No hay productos disponibles.');
                return;
            }

            productsContainer.innerHTML = productsToRender.map(renderProductCard).join('');
            setupCarousels();
            messageElement.classList.add('hidden');
        };
    </script>
</body>
</html>
