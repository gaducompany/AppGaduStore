<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GADU App - Contenedores</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* CSS Base */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .header-logo { height: 50px; width: auto; }
        .product-card-link { text-decoration: none; color: inherit; }

        /* Estilos específicos del Carrusel de Banners */
        .banner-slide {
            display: none;
            height: 100%; 
            width: 100%;
        }
        .banner-slide.active {
            display: block;
        }
        .banner-dot {
            height: 10px; width: 10px; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; cursor: pointer; transition: background-color 0.3s ease;
        }
        .banner-dot.active {
            background-color: #13B71C;
        }

        /* Estilos para el carrusel de imágenes de productos */
        .image-carousel {
            position: relative; width: 100%; height: 192px; overflow: hidden; border-radius: 0.5rem;
        }
        .image-carousel img {
            width: 100%; height: 100%; object-fit: cover; display: none;
        }
        .image-carousel img.active {
            display: block;
        }
        .carousel-btn {
            position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.5); color: white; padding: 8px; border-radius: 50%; cursor: pointer; z-index: 10; transition: background-color 0.3s ease;
        }
        .carousel-btn:hover { background-color: rgba(0, 0, 0, 0.8); }
        .carousel-btn.prev { left: 8px; }
        .carousel-btn.next { right: 8px; }
        .carousel-dots {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 10;
        }
        .image-dot {
            height: 10px; width: 10px; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; cursor: pointer; transition: background-color 0.3s ease;
        }
        .image-dot.active { background-color: #13B71C; }
        
        /* NUEVO: Estilo para las burbujas de categoría */
        .category-bubble:hover {
            box-shadow: 0 4px 10px rgba(19, 183, 28, 0.4);
            background-color: white; /* Fondo blanco al pasar el ratón para resaltar */
        }
    </style>
    <link rel="icon" href="assets/icon.png">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2">
                <img src="assets/icon.png" alt="GADU Containers Logo" class="header-logo">
                <span class="text-3xl font-bold text-gray-800">
                    <span style="color: #13B71C;">GADU</span>
                </span>
            </a>
            <nav>
                <ul class="flex space-x-4">
                    <li><a href="#" class="text-gray-600 hover:text-green-600 transition-colors duration-300 font-medium">Inicio</a></li>
                    <li><a href="contact.html" class="text-gray-600 hover:text-green-600 transition-colors duration-300 font-medium">Contacto</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">

        <div id="banner-carousel" class="relative w-full h-[550px] rounded-2xl overflow-hidden shadow-2xl mb-10">
            
            <div class="banner-slide active" 
                 style="background-image: url('assets/bannerglobal.png'); background-size: cover; background-position: center;">
            </div>
            
            <div class="banner-slide" 
                 style="background-image: url('assets/bannertech.png'); background-size: cover; background-position: center;">
            </div>

            <div class="banner-slide" 
                 style="background-image: url('assets/bannersport.png'); background-size: cover; background-position: center;">
            </div>

            <div class="banner-slide" 
                 style="background-image: url('assets/bannerfashion.png'); background-size: cover; background-position: center;">
            </div>
            
            <button id="banner-prev" class="carousel-btn prev p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <button id="banner-next" class="carousel-btn next p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>

            <div id="banner-dots-container" class="carousel-dots">
                <span class="banner-dot active" data-index="0"></span>
                <span class="banner-dot" data-index="1"></span>
                <span class="banner-dot" data-index="2"></span>
                <span class="banner-dot" data-index="3"></span>
            </div>
        </div>
        <div class="py-6 mb-10 bg-white rounded-xl shadow-lg">
            <div id="category-bubbles" class="flex justify-around items-start flex-wrap gap-4 px-4">
                
                <div class="category-bubble text-center cursor-pointer p-4 rounded-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-50" data-category="Tecnologia">
                    <div class="w-20 h-20 mx-auto mb-2 rounded-full flex items-center justify-center border-4" style="border-color: #13B71C; background-color: rgba(19, 183, 28, 0.1);">
                        <img src="assets/icon-tecnologia.png" alt="Icono Tecnología" class="w-12 h-12 object-contain">
                    </div>
                    <p class="font-semibold text-gray-700">Tecnología</p>
                </div>
                
                <div class="category-bubble text-center cursor-pointer p-4 rounded-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-50" data-category="Moda">
                    <div class="w-20 h-20 mx-auto mb-2 rounded-full flex items-center justify-center border-4" style="border-color: #13B71C; background-color: rgba(19, 183, 28, 0.1);">
                        <img src="assets/icon-moda.png" alt="Icono Moda" class="w-12 h-12 object-contain">
                    </div>
                    <p class="font-semibold text-gray-700">Moda</p>
                </div>
                
                <div class="category-bubble text-center cursor-pointer p-4 rounded-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-50" data-category="Calzado">
                    <div class="w-20 h-20 mx-auto mb-2 rounded-full flex items-center justify-center border-4" style="border-color: #13B71C; background-color: rgba(19, 183, 28, 0.1);">
                        <img src="assets/icon-calzado.png" alt="Icono Calzado" class="w-12 h-12 object-contain">
                    </div>
                    <p class="font-semibold text-gray-700">Calzado</p>
                </div>
                
                <div class="category-bubble text-center cursor-pointer p-4 rounded-xl transition-all duration-300 transform hover:scale-105 hover:bg-gray-50" data-category="all">
                    <div class="w-20 h-20 mx-auto mb-2 rounded-full flex items-center justify-center border-4" style="border-color: #13B71C; background-color: rgba(19, 183, 28, 0.1);">
                    <img src="assets/icon-todo.png" alt="Icono Ver Todo" class="w-12 h-12 object-contain">
                    </div>
                    <p class="font-semibold text-gray-700">Ver Todo</p>
                </div>
            </div>
        </div>
        <h1 class="text-center text-4xl font-extrabold text-gray-800 mb-8">Nuestros Productos</h1>

        <div class="bg-white p-6 rounded-lg shadow-sm mb-8 flex flex-col md:flex-row justify-between items-start md:items-end space-y-4 md:space-y-0 md:space-x-4">
    
            <div class="w-full md:flex-1">
                <label for="search-input" class="block text-gray-700 font-semibold mb-1">Buscar:</label>
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="Nombre, Categoría o Subcategoría" 
                    class="w-full p-2 border border-green-500 rounded-md focus:outline-none focus:ring-2 focus:ring-green-300" 
                    style="border-color: #13B71C; box-shadow: 0 0 0 1px #13B71C;">
            </div>

            <div class="w-full md:flex-1">
                <label for="category-filter" class="block text-gray-700 font-semibold mb-1">Categoría:</label>
                <select 
                    id="category-filter" 
                    class="w-full p-2 border border-green-500 rounded-md focus:outline-none focus:ring-2 focus:ring-green-300 appearance-none bg-white pr-8"
                    style="border-color: #13B71C; box-shadow: 0 0 0 1px #13B71C;">
                    <option value="all">Todas las Categorías</option>
                    </select>
            </div>

            <div class="w-full md:flex-1">
                <label for="subcategory-filter" class="block text-gray-700 font-semibold mb-1">Subcategoría:</label>
                <select 
                    id="subcategory-filter" 
                    class="w-full p-2 border border-green-500 rounded-md focus:outline-none focus:ring-2 focus:ring-green-300 appearance-none bg-white pr-8"
                    style="border-color: #13B71C; box-shadow: 0 0 0 1px #13B71C;">
                    <option value="all">Todas las Subcategorías</option>
                    </select>
            </div>

            <div class="w-full md:flex-1">
                <label for="sort-by-price" class="block text-gray-700 font-semibold mb-1">Precio:</label>
                <select 
                    id="sort-by-price" 
                    class="w-full p-2 border border-green-500 rounded-md focus:outline-none focus:ring-2 focus:ring-green-300 appearance-none bg-white pr-8"
                    style="border-color: #13B71C; box-shadow: 0 0 0 1px #13B71C;">
                    <option value="default">Por Defecto</option>
                    <option value="asc">Menor a Mayor</option>
                    <option value="desc">Mayor a Menor</option>
                </select>
            </div>
        </div>
        <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            </div>

        <div id="pagination-controls" class="flex justify-center items-center space-x-4 mt-10 mb-8">
            <button id="prev-page-btn" class="bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-400 transition-colors duration-300 disabled:opacity-50" disabled>
                Anterior
            </button>
            <span id="page-info" class="text-lg font-medium text-gray-700">Página 1</span>
            <button id="next-page-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition-colors duration-300 disabled:opacity-50">
                Siguiente
            </button>
        </div>

        <div id="message" class="text-center text-gray-500 font-medium mt-8 hidden"></div>
    </main>

    <footer class="text-white text-center p-4" style="background-color: #84a484;">
        <div class="container mx-auto">
            <p>&copy; 2024 GADU App. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script type="module">
        // Importaciones de Firebase con WHERE, ORDERBY, LIMIT y STARTAFTER para paginación/filtrado
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, limit, startAfter, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // **PASO 1: Inserta tu objeto de configuración de Firebase aquí (Original)**
        const firebaseConfig = {
            apiKey: "AIzaSyCsRnbAvV5vLDv5-rMq8uT7rcCK9YRz-UA",
            authDomain: "appgadustore.firebaseapp.com",
            projectId: "appgadustore",
            storageBucket: "appgadustore.firebasestorage.app",
            messagingSenderId: "761196485216",
            appId: "1:761196485216:web:612176268c5f2480304105",
            measurementId: "G-VDKN4343F7"
        };

        // Inicializa Firebase
        let firebaseApp;
        let db;
        try {
            firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
        } catch (e) {
            console.error("Error al inicializar Firebase. Revisa tu objeto de configuración.", e);
        }

        const productsContainer = document.getElementById('products-container');
        const messageElement = document.getElementById('message');
        const categoryFilter = document.getElementById('category-filter');
        const subcategoryFilter = document.getElementById('subcategory-filter');
        const sortByPrice = document.getElementById('sort-by-price');
        const searchInput = document.getElementById('search-input');
        let allProducts = [];

        // 👇 VARIABLES DE PAGINACIÓN
        const PRODUCTS_PER_PAGE = 20; 
        let paginationHistory = [null]; 
        let currentPage = 1;
        
        // 👇 REFERENCIAS A LOS BOTONES DE PAGINACIÓN
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfo = document.getElementById('page-info');

        // === Lógica del Carrusel de Banners (Original) ===
        const bannerSlides = document.querySelectorAll('#banner-carousel .banner-slide');
        const bannerDotsContainer = document.getElementById('banner-dots-container');
        const bannerPrevBtn = document.getElementById('banner-prev');
        const bannerNextBtn = document.getElementById('banner-next');
        let currentBannerIndex = 0;
        let bannerInterval;
        const totalBanners = bannerSlides.length;

        const updateBannerCarousel = (newIndex) => {
            if (totalBanners === 0) return;
            let finalIndex = (newIndex + totalBanners) % totalBanners;
            
            bannerSlides.forEach(slide => slide.classList.remove('active'));
            const bannerDots = bannerDotsContainer.querySelectorAll('.banner-dot');
            bannerDots.forEach(dot => dot.classList.remove('active'));
            
            bannerSlides[finalIndex].classList.add('active');
            if (bannerDots[finalIndex]) {
                bannerDots[finalIndex].classList.add('active');
            }
            currentBannerIndex = finalIndex;
        };

        const startBannerAutoPlay = () => {
            clearInterval(bannerInterval);
            bannerInterval = setInterval(() => {
                updateBannerCarousel(currentBannerIndex + 1);
            }, 5000);
        };

        bannerNextBtn.addEventListener('click', () => {
            updateBannerCarousel(currentBannerIndex + 1);
            startBannerAutoPlay();
        });

        bannerPrevBtn.addEventListener('click', () => {
            updateBannerCarousel(currentBannerIndex - 1);
            startBannerAutoPlay();
        });
        // === FIN: Lógica del Carrusel de Banners ===
        
        // NUEVA FUNCIÓN: Configuración de las Burbujas de Categoría
        const setupCategoryBubbles = () => {
            const bubbles = document.querySelectorAll('.category-bubble');
            bubbles.forEach(bubble => {
                bubble.addEventListener('click', () => {
                    const category = bubble.dataset.category;
                    
                    categoryFilter.value = category; 
                    
                    currentPage = 1;
                    paginationHistory = [null];
                    handleCategoryChange(); 

                    document.getElementById('products-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
        };


        // Función para mostrar mensajes de estado (Original)
        const showMessage = (msg) => {
            messageElement.textContent = msg;
            messageElement.classList.remove('hidden');
        };

        // ==========================================================
        // FUNCIÓN: renderProductCard (MODIFICADA para Categoría | Subcategoría)
        // ==========================================================
        const renderProductCard = (product) => {
            const imageUrls = Array.isArray(product.imageUrl) ? product.imageUrl : [product.imageUrl];
            const hasMultipleImages = imageUrls.length > 1;

            const imagesHtml = imageUrls.map((url, index) => {
                return `<img src="${url}" alt="${product.name} - ${index + 1}" class="w-full h-full object-cover ${index === 0 ? 'active' : ''}">`;
            }).join('');

            const dotsHtml = hasMultipleImages ? imageUrls.map((_, index) => {
                return `<span class="image-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`;
            }).join('') : '';

            // Lógica para mostrar Categoría | Subcategoría
            let categorySubcategoryHtml = `<p class="text-sm text-gray-500 mb-2">${product.category}</p>`;

            // Si existe la subcategoría, la fusionamos con un divisor " | "
            if (product.subcategory) {
                categorySubcategoryHtml = `<p class="text-sm text-gray-500 mb-2">${product.category} | ${product.subcategory}</p>`;
            }

            return `
                <a href="product-details.html?id=${product.id}" class="product-card-link">
                    <div class="relative bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 overflow-hidden" style="box-shadow: 0 4px 6px -1px #84a484, 0 2px 4px -1px #84a484;">
                        <div class="image-carousel" data-product-id="${product.id}" data-current-index="0" data-has-multiple="${hasMultipleImages}">
                            ${imagesHtml}
                            ${hasMultipleImages ? `
                                <button class="carousel-btn prev" onclick="event.preventDefault(); event.stopPropagation();">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                    </svg>
                                </button>
                                <button class="carousel-btn next" onclick="event.preventDefault(); event.stopPropagation();">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                </button>
                                <div class="carousel-dots">
                                    ${dotsHtml}
                                </div>
                            ` : ''}
                        </div>
                        <h2 class="text-xl font-bold text-gray-800 mt-4 mb-1">${product.name}</h2>
                        ${categorySubcategoryHtml} <p class="text-2xl font-extrabold" style="color: #13B71C;">$${product.price.toLocaleString('es-CO')}</p>
                    </div>
                </a>
            `;
        };
        
        const updateCarousel = (carousel, newIndex) => {
            const images = carousel.querySelectorAll('img');
            const dots = carousel.querySelectorAll('.image-dot');
            const totalImages = images.length;
            
            if (totalImages === 0) return;

            const finalIndex = (newIndex + totalImages) % totalImages;
            
            images.forEach(img => img.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));

            images[finalIndex].classList.add('active');
            if (dots[finalIndex]) {
                dots[finalIndex].classList.add('active');
            }

            carousel.dataset.currentIndex = finalIndex;
        };
        
        const setupCarousels = () => {
            const carousels = document.querySelectorAll('.image-carousel');
            carousels.forEach(carousel => {
                if (carousel.dataset.initialized) return;

                const hasMultipleImages = carousel.dataset.hasMultiple === 'true';
                if (!hasMultipleImages) return;

                const prevBtn = carousel.querySelector('.prev');
                const nextBtn = carousel.querySelector('.next');
                const dots = carousel.querySelectorAll('.image-dot');

                updateCarousel(carousel, 0);

                const handleNavigation = (e, step) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const currentIndex = parseInt(carousel.dataset.currentIndex);
                    updateCarousel(carousel, currentIndex + step);
                };

                nextBtn.addEventListener('click', (e) => handleNavigation(e, 1));
                prevBtn.addEventListener('click', (e) => handleNavigation(e, -1));

                dots.forEach(dot => {
                    dot.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const newIndex = parseInt(e.target.dataset.index);
                        updateCarousel(carousel, newIndex);
                    });
                });

                carousel.dataset.initialized = 'true';
            });
        };

        const renderProducts = (productsToRender) => {
            if (productsToRender.length === 0) {
                productsContainer.innerHTML = '';
                if (!searchInput.value.trim()) {
                    showMessage('No se encontraron productos que coincidan con los filtros.');
                } else {
                    showMessage('No se encontraron productos con esos términos de búsqueda en esta página.');
                }
                return;
            }
            productsContainer.innerHTML = productsToRender.map(renderProductCard).join('');
            setupCarousels();
            messageElement.classList.add('hidden');
        };

        // Rellena el dropdown de Subcategorías (Se basa en 'allProducts' cargados)
        const populateSubcategories = (selectedCategory) => {
            subcategoryFilter.innerHTML = '<option value="all">Todas las Subcategorías</option>'; 
            
            if (selectedCategory === 'all') {
                return;
            }
            
            const filteredProducts = allProducts.filter(p => p.category === selectedCategory);
            const subcategories = [...new Set(filteredProducts.map(p => p.subcategory).filter(Boolean))].sort();

            subcategories.forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory;
                option.textContent = subcategory;
                subcategoryFilter.appendChild(option);
            });
        };

        // Rellena el dropdown de Categorías (Se basa en 'allProducts' cargados)
        const populateFilters = (products) => {
            const categories = [...new Set(products.map(p => p.category))].filter(Boolean).sort();
            categoryFilter.innerHTML = '<option value="all">Todas las Categorías</option>';
            
            categories.forEach(category => {
                if (categoryFilter.value !== category) { 
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                }
            });
            populateSubcategories(categoryFilter.value); 
        };

        // Maneja el evento de cambio de categoría (Reinicia paginación y llama a fetchProducts)
        const handleCategoryChange = () => {
            const selectedCategory = categoryFilter.value;
            populateSubcategories(selectedCategory);
            subcategoryFilter.value = 'all'; 
            fetchProducts();
        };

        // 👇 FUNCIÓN DE PAGINACIÓN: Actualiza el estado de los botones
        const updatePaginationControls = (docs) => {
            const hasMorePages = docs.length === PRODUCTS_PER_PAGE;
            
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = !hasMorePages; 

            pageInfo.textContent = `Página ${currentPage}`;
        };

        // 👇 FUNCIÓN DE PAGINACIÓN: Manejador de clics
        const setupPaginationListeners = () => {
            nextPageBtn.addEventListener('click', () => {
                if (!nextPageBtn.disabled) {
                    currentPage++;
                    fetchProducts(); 
                    document.getElementById('products-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    // Quitamos el cursor de la página que ya no vamos a mostrar
                    if (paginationHistory.length > 1) {
                       paginationHistory.pop(); 
                    }
                    fetchProducts(); 
                    document.getElementById('products-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        };


        // Cargar productos de Firestore con Paginación, Filtro y Orden
        const fetchProducts = async () => {
            let productsSnapshot;
            const selectedCategory = categoryFilter.value;
            const selectedSubcategory = subcategoryFilter.value; 
            const selectedSort = sortByPrice.value;
            const searchTerm = searchInput.value.toLowerCase().trim();

            try {
                showMessage('Cargando productos...');
                if (!db) {
                    throw new Error('Firestore no está inicializado.');
                }
                
                let productsRef = collection(db, 'products');
                let q = query(productsRef);

                // ==========================================================
                // 1. APLICAR FILTROS Y ORDENAMIENTO EN LA CONSULTA (Firestore)
                // ==========================================================
                
                if (selectedCategory !== 'all') {
                    q = query(q, where('category', '==', selectedCategory));
                }
                if (selectedSubcategory !== 'all') {
                    q = query(q, where('subcategory', '==', selectedSubcategory));
                }

                let orderByField = 'price'; 
                let sortDirection = selectedSort === 'desc' ? 'desc' : 'asc';
                
                if (selectedSort !== 'default') {
                    // CRÍTICO: Se incluye 'id' como desempate para que el cursor funcione correctamente
                    q = query(q, orderBy(orderByField, sortDirection), orderBy('id')); 
                } else {
                    q = query(q, orderBy('name')); 
                }
                
                // ==========================================================
                // 2. APLICAR PAGINACIÓN (Cursor de Firestore)
                // ==========================================================

                let startCursor = null;
                
                if (currentPage > 1) {
                    // CORRECCIÓN CLAVE: El cursor para la Página N (e.g., P2) está en el índice N-1 del historial.
                    if (paginationHistory.length >= currentPage) {
                         // Usamos currentPage - 1 para acceder al cursor del final de la página anterior
                         startCursor = paginationHistory[currentPage - 1]; 
                    } else {
                        // Lógica de seguridad
                        currentPage = paginationHistory.length; 
                        startCursor = paginationHistory[currentPage - 1];
                    }
                }
                
                if (startCursor) {
                    q = query(q, startAfter(startCursor));
                }
                
                q = query(q, limit(PRODUCTS_PER_PAGE));


                // 3. Ejecutar la consulta
                productsSnapshot = await getDocs(q);
                const docs = productsSnapshot.docs;
                
                // 4. Manejo de fin de colección
                if (docs.length === 0 && currentPage > 1) {
                    currentPage--; 
                    paginationHistory.pop(); 
                    showMessage('No hay más productos con los filtros seleccionados.');
                    updatePaginationControls([]); 
                    return; 
                }
                
                // ==========================================================
                // 5. GUARDAR CURSOR PARA LA PRÓXIMA PÁGINA
                // ==========================================================
                if (docs.length > 0) {
                    if (currentPage >= paginationHistory.length) { 
                        // Guardamos el último documento de la página actual para usarlo como cursor de la siguiente.
                        paginationHistory.push(docs[docs.length - 1]);
                    }
                }
                
                // 6. Mapear datos y aplicar filtro de BÚSQUEDA LOCAL
                allProducts = docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                let productsToRender = [...allProducts];
                if (searchTerm) {
                    productsToRender = productsToRender.filter(product => {
                        const nameMatch = product.name.toLowerCase().includes(searchTerm);
                        const categoryMatch = product.category ? product.category.toLowerCase().includes(searchTerm) : false;
                        const subcategoryMatch = product.subcategory ? product.subcategory.toLowerCase().includes(searchTerm) : false;
                        return nameMatch || categoryMatch || subcategoryMatch;
                    });
                }
                
                // 7. Rellenar filtros y Renderizar
                if (currentPage === 1) {
                     populateFilters(allProducts); 
                }
                
                renderProducts(productsToRender);

            } catch (error) {
                showMessage(`Error al cargar productos: ${error.message}. Asegúrate de crear los índices compuestos necesarios.`);
                console.error('Error al cargar productos:', error);
            }
            updatePaginationControls(productsSnapshot ? productsSnapshot.docs : []);
        };

        // Event Listeners para los filtros (Reinician la paginación a la página 1)
        categoryFilter.addEventListener('change', () => { 
             currentPage = 1;
             paginationHistory = [null];
             handleCategoryChange(); 
        }); 

        subcategoryFilter.addEventListener('change', () => {
             currentPage = 1; 
             paginationHistory = [null];
             fetchProducts();
        });

        sortByPrice.addEventListener('change', () => {
             currentPage = 1; 
             paginationHistory = [null];
             fetchProducts();
        });
        
        searchInput.addEventListener('input', () => { 
             currentPage = 1; 
             paginationHistory = [null];
             fetchProducts();
        });


        // Iniciar la carga y los listeners al cargar la página
        window.addEventListener('load', () => {
            const bannerDots = bannerDotsContainer.querySelectorAll('.banner-dot');
            bannerDots.forEach(dot => {
                dot.addEventListener('click', (e) => {
                    const targetIndex = parseInt(e.target.dataset.index);
                    updateBannerCarousel(targetIndex);
                    startBannerAutoPlay();
                });
            });
            startBannerAutoPlay();
            
            setupCategoryBubbles(); 
            setupPaginationListeners();
            
            // Carga la primera página (20 productos) con filtros por defecto
            fetchProducts();
        });
    </script>
</body>
</html>
